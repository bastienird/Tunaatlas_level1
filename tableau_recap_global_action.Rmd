---
title: "Summary of the treatment for a specific entity of the global tuna atlas"
eval.expr: TRUE
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    always_allow_html: true
    fig_caption: true
    tab_caption: true
    lof: true
    lot: true   
    alternative-title-page: front-and-back-matter/alt-title-page-example.tex
    header-includes:
    - \usepackage{booktabs}
    - \usepackage[T1]{fontenc}
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    global_numbering: true
    toc_float: true
    toc_collapsed: true
    fig_caption: yes
    tab_caption: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  action: action
  entity: entity
  config: config
  filter_species: !r NULL
  filter_source_authority: !r NULL
  filter_gear: !r NULL
  filter_fishingfleet: !r NULL
  filter_time_start: !r NULL
  filter_time_end: !r NULL
  filter_cat_geo: !r NULL
  filter_catchtype: !r NULL
  filter_schooltype: !r NULL
  filter_species_group: !r NULL
  fact: "catch"
---

 \clearpage


This document is aimed to recap the impact on the data of the different treatment of the Global Tuna Atlas. 

```{r include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, fig.align = 'center'
)

```

```{r}
opts <- params$action
con <- config$software$output$dbi
```

```{r}
knitr::knit_hooks$set(inline = function(x) {   if(!is.numeric(x)){     x   }else{    prettyNum(round(x,2), big.mark=",")    } })
parameter_fact <-  "catch"
if(!(require(base))){ 
  install.packages("base") 
  (require(base))} 
if(!(require(flextable))){ 
  install.packages("flextable") 
  (require(flextable))} 
if(!(require(remotes))){ 
  install.packages("remotes") 
  (require(remotes))} 
if(!(require(utils))){ 
  install.packages("utils") 
  (require(utils))} 
if(!(require(stringr))){ 
  install.packages("stringr") 
  (require(stringr))} 
if(!(require(knitr))){ 
  install.packages("knitr") 
  (require(knitr))} 
if(!(require(DBI))){ 
  install.packages("DBI") 
  (require(DBI))} 
if(!(require(odbc))){ 
  install.packages("odbc") 
  (require(odbc))} 
if(!(require(sf))){ 
  install.packages("sf") 
  (require(sf))} 
if(!(require(dplyr))){ 
  install.packages("dplyr") 
  (require(dplyr))} 
if(!(require(kableExtra))){ 
  install.packages("kableExtra") 
  (require(kableExtra))} 
if(!(require(readxl))){ 
  install.packages("readxl") 
  (require(readxl))} 
if(!(require(readr))){ 
  install.packages("readr") 
  (require(readr))} 
if(!(require(tidyr))){ 
  install.packages("tidyr") 
  (require(tidyr))} 
if(!(require(ggplot2))){ 
  install.packages("ggplot2") 
  (require(ggplot2))} 
if(!(require(stats))){ 
  install.packages("stats") 
  (require(stats))} 
if(!(require(RColorBrewer))){ 
  install.packages("RColorBrewer") 
  (require(RColorBrewer))} 
if(!(require(cowplot))){ 
  install.packages("cowplot") 
  (require(cowplot))} 
if(!require(sutdycatchesird)){
  if(!require(remotes)){
    install.packages("remotes")
  }
  require(remotes)
  install_github("BastienIRD/sutdycatchesird")
  require(sutdycatchesird)
}
if(!(require(tmap))){ 
  install.packages("tmap") 
  (require(tmap))} 
if(!(require(RPostgreSQL))){ 
  install.packages("RPostgreSQL") 
  (require(RPostgreSQL))} 
if(!(require(officer))){ 
  install.packages("officer") 
  (require(officer))} 
if(!(require(readtext))){ 
  install.packages("readtext") 
  (require(readtext))} 
```


```{r}
for (i in 1:length(params)){assign(paste0("parameter_",names(params)[i]), params[i][[1]])}

```


```{r}
# knitr::opts_chunk$set(tab.cap.pre = "Table ", tab.cap.sep = ": ")

#set the table caption styling
# autonum <- officer::run_autonum(seq_id = "tab", bkm = "TC1", bkm_all = TRUE) # number the table, bkm (bookmark) is important as the cross-referencing is done using the bookmark
set_flextable_defaults(
  font.size = 10,
  font.color = "black",
  digits = 2,
  theme_fun = "theme_box"
)
qflextable2 =function(x, captionn = NULL, autonumm = autonum, pgwidth = 6, colour = FALSE){
  if("Captures table 1" %in% colnames(x)){
    y <-x %>% dplyr::mutate(`Captures table 1` = round(`Captures table 1`)) } 

  else {y <- x}
  y <- y %>% dplyr::mutate_if(is.factor, as.character) %>% dplyr::mutate_if(is.character, ~str_replace_all( ., ",", ", \n" )) %>% 
  dplyr::mutate_if(is.character,~str_replace_all( ., "_", "-" )) %>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})
  flextable <- flextable(y)
  if(colour){
  flextable <- flextable %>% 
          color(~ `Difference (in % of tons)` < 0, color = "green",~ `Difference (in % of tons)`) %>% 
          color(~ `Difference (in % of tons)` >0, color = "red",~ `Difference (in % of tons)`)%>%   color(~ `Difference (in % of fish)` < 0, color = "green",~ `Difference (in % of fish)`) %>% 
          color(~ `Difference (in % of fish)` >0, color = "red",~ `Difference (in % of fish)`)%>%color(~ `Difference (in % of lines)` < 0, color = "green",~ `Difference (in % of lines)`) %>% 
          color(~ `Difference (in % of lines)` >0, color = "red",~ `Difference (in % of lines)`)
  } 
  if(!is.null(captionn)){flextable_captionned <- set_caption(flextable, caption = captionn,
  style = "Table Caption")} else {flextable_captionned <- flextable}
  ft_out <- flextable_captionned %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))

  return(ft_out)

}
base::options(knitr.duplicate.label = "allow")#for duplicate chunk names

```



```{r include=FALSE, results='asis'}
params_unlock <- params
for (i in length(params_unlock)){names(params_unlock[i]) <- substitute(i)}
list_param <- list(params_unlock$filter_cat_geo, params_unlock$filter_gear, params_unlock$filter_source_authority, params_unlock$filter_fishingfleet, params_unlock$filter_time_start, params_unlock$filter_time_end, params_unlock$filter_species, params_unlock$filter_catchtype)
isNullList <- function(x) all(!lengths(x))
if (isNullList(list_param)){cat("There are no filter on this data")} else {
  
  cat (paste0("The filter used on this data are:  \n "))
  for (i in 1:length(params_unlock)){
    if (params_unlock[i] %in% list_param & !is.null(params_unlock[[i]])){
      cat(paste0("***- On ", names((params_unlock)[i]), " : ", paste((params_unlock)[[i]], collapse = " ; "),"*** \n "))} else {""}
  }
}

```

```{r include=FALSE}
if(dir.exists("Markdown")){

  nominal_dataset <- readr::read_csv(paste0(getwd(),"/data/global_nominal_catch_firms_level0.csv"))


  }
```


```{r include=FALSE}

  if(!(is.null(params$filter_species))){nominal <- sum((nominal_dataset %>% 
                                                          dplyr::filter(species %in% params$filter_species))$value)
  } else {nominal <- sum(nominal_dataset$value)}
  
```

First we present the different steps created while processing the data. 

Secondly we will present the differences between the first dataset (only groupping data) and the last one, after all the processes. 

Thirdly, we will analyse further the final data, checking the eventual mistakes.

Last we will present the differences between the created dataset and the one we provide in the Global Tuna Atlas. 

# Analyse of the processing of the data

```{r include=FALSE}
sub_list_dir_2 <- list.dirs(path =paste0(getwd(),"/Markdown"), full.names = TRUE, recursive = FALSE)
details = file.info(paste0(sub_list_dir_2,"/Markdown"))
details = file.info(sub_list_dir_2)
details = details[with(details, order(as.POSIXct(mtime))), ]
sub_list_dir_2 = rownames(details)
```


```{r include=FALSE}
df <- data.frame(matrix(ncol =12, nrow = 1))
      colnames(df) <- c(paste0(tail(str_split(paste0(sub_list_dir_2),"/")[[1]],n=1)),
                        "Explanation", "Fonctions", 
                        "Options", "Sum in tons", "Sum in number of fish", "Number of lines","Difference (in % of tons)","Difference in tons","Difference (in % of fish)", "Difference (in % of lines)", "Percentage of nominal"
      )
      if((!is.null(opts))){ #have not change for species$filter
        tons_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[1])
        lines_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[3])
        nofish_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[2])} else{
          main <- readRDS(paste0(sub_list_dir_2[1],"/rds.rds")) %>% dplyr::filter(species%in%opts$species_filter)
          tons_init <- sum((main %>% dplyr::filter(unit%in%c("MTNO", "MT")))$value)
          nofish_init <- sum((main %>% dplyr::filter(unit%in%c("NOMT", "NO")))$value)
          lines_init <- nrow(main)
        }
      for (i in sub_list_dir_2){
        sums <- read.csv(paste0(i,"/sums.csv"))
        Explanation <- readtext(paste0(i,"/explication.txt"))[2]
        Fonctions <- pull(readtext(paste0(i,"/fonctions.txt"))[2])
        if (file.exists(paste0(i,"/options_written.txt"))){
          Options <- pull(readtext(paste0(i,"/options_written.txt"))[2])} else {Options <- "Aucune"}
        if(!is.null(params$filter_species)){
          main <- readRDS(paste0(i,"/rds.rds")) %>% dplyr::filter(species%in%params$filter_species)
          sum_t <- sum((main %>% dplyr::filter(unit%in%c("MTNO", "MT")))$value)
          sum_no <- sum((main %>% dplyr::filter(unit%in%c("NOMT", "NO")))$value)
          nrow <- nrow(main)
          
        } else{sum_t <- pull(sums[1])
        sum_no <-  pull(sums[2])
        nrow <- pull(sums[3])}
        
        step <- tail(str_split(paste0(i),"/")[[1]],n=1)
        loss_percent <- 100*((tons_init - sum_t)/tons_init)
        loss_tons <- (tons_init - sum_t)
        loss_percent_lines <- 100*((lines_init - nrow)/lines_init)
        loss_percent_no <- 100*((nofish_init - sum_no)/nofish_init)
        percentage_of_nominal <- (sum_t*100)/nominal
        sums <- as.data.frame(data.frame(sum_t, sum_no, nrow))
        data_i <- cbind(step,
                        Explanation, Fonctions, 
                        Options,
                        sums, loss_percent,loss_tons,loss_percent_no, loss_percent_lines, percentage_of_nominal)
        names(data_i) <- colnames(df)
        df <- rbind(df, data_i)
        tons_init <- sum_t
        nofish_init <- sum_no
        lines_init <- nrow
        
      }
      df = df[-1,]
      df[df == -Inf] <- 0
      df <- df %>%  rename(Step = rawdata)



     

      reduced <- df %>% select(Step, `Sum in tons`, `Sum in number of fish`, `Number of lines`)%>% dplyr::mutate(Step_number = as.numeric(row_number()))
      reduced$Step <- factor(reduced$Step, levels = (reduced %>% arrange(Step_number))$Step)
      

coeff <- 3
temperatureColor <- "#69b3a2"
      
priceColor <- rgb(0.2, 0.6, 0.9, 1)

second_graf <- ggplot(reduced,aes(x = Step,group = 1))+ 
        geom_line( aes(y=`Sum in tons` ,group = 1), size=0.5, color=priceColor)+geom_point( aes(y=`Sum in tons` ,group = 1)) +
        geom_line( aes(y=`Sum in number of fish`/ coeff,group = 1), size=0.5, color=temperatureColor)+geom_point( aes(y=`Sum in number of fish`/ coeff))  +
        scale_y_continuous(
          
          # Features of the first axis
          name = "Tons",
          
          # Add a second axis and specify its features
          sec.axis = sec_axis(~.*coeff, name="Number of fish")
        ) + 
        
        
        
        theme(
          axis.title.y = element_text(color = priceColor, size=8),
          axis.title.y.right = element_text(color = temperatureColor, size=8)
        ) +
        
        ggtitle("Evolution of the repartition of captures depending on units and Steps")+
        theme(axis.text.x = element_text(angle = 90))

no_fish_plot <- ggplot(reduced,aes(x = Step,group = 1)) +geom_line( aes(y=`Sum in number of fish`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
      
tons_plot <- ggplot(reduced,aes(x = Step,group = 1)) +
geom_line( aes(y=`Sum in tons`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
```


```{r echo=FALSE, results='asis'}
qflextable2(reduced, colour = FALSE, captionn ="Evolution of Sum in tons and Sum in number of fish and lines along the steps")
```


```{r echo=FALSE, results='asis'}

qflextable2(df %>% select(-c("Sum in tons", "Sum in number of fish", "Number of lines", "Difference in tons","Options")), colour = TRUE, captionn ="Review of all the impact and purpose of every the treatment done")

```






```{r echo=FALSE, fig.cap='Evolution of captures in tons and number of fish during the process',results='asis'}



cowplot::plot_grid(tons_plot, no_fish_plot)



```



```{r eval=FALSE, include=FALSE, results='asis'}
res3 <- knitr::knit_child("tableau_recap_entity_child.Rmd", envir = globalenv(), quiet = TRUE)
cat(res3, sep =  "\\clearpage")

```



```{r}


last_path = function(x){tail(stringr::str_split(x,"/")[[1]],n=1)}

```


# Analyse of the final data

```{r echo=FALSE, results='asis'}
parameter_init <- sub_list_dir_2[1]
parameter_final <- sub_list_dir_2[length(sub_list_dir_2)]
child <- TRUE
res2 <- knitr::knit_child("Analyse_georeferenced_child.Rmd", envir = environment(), quiet = TRUE)
```



 \clearpage


```{r echo=FALSE, results='asis'}

cat(res2, sep =  "\\clearpage")


```

# Summary of the treatment done on the data (comparison between the first to the last)

```{r echo=FALSE, results='asis'}

child <- TRUE
res <- knitr::knit_child("comp_sans_shiny_child.Rmd", envir = globalenv(), quiet = TRUE)

```

\clearpage


```{r echo=FALSE, results='asis'}



cat(res, sep =  "\\clearpage")

```


# Analyse of all the steps of treatment of the data

For each treatment on the data, we provide a report on what exactly has been created, disappeared or has been transformed.

```{r echo=FALSE, results='asis'}
cat("## Step 1")
```

```{r eval  =FALSE}
for (counteur_child_tableau_recap in (1:(length(sub_list_dir_2)-1)))  {  
  print(paste0("compteur = ",counteur_child_tableau_recap))
  parameter_init <- sub_list_dir_2[counteur_child_tableau_recap]
  print(paste0("param init = ",parameter_init))
  parameter_final <- sub_list_dir_2[counteur_child_tableau_recap+1]
  print(parameter_final)
  print("new")


  }
```

```{r}
function_all_comp <- function(counting){
  parameter_init <- sub_list_dir_2[counting]
  parameter_final <- sub_list_dir_2[counting+1]
  parameter_short <- TRUE
  cat(paste0("## Step ", step, " from ", last_path(parameter_init), " to ", last_path(parameter_final)))
  knitr::knit_child("comp_sans_shiny_child.Rmd", envir = globalenv(), quiet = TRUE, options = list(parameter_init = parameter_init, parameter_final = parameter_final))
}

all <- lapply(1:(length(sub_list_dir_2)-1), function_all_comp)

```

```{r echo=FALSE, results='asis'}
cat(all, sep = paste0( "\\clearpage"))

```


```{r echo = FALSE, results='asis', eval=FALSE}
step <- 1
for (counteur_child_tableau_recap in (1:(length(sub_list_dir_2)-1)))  {  
  parameter_init <- sub_list_dir_2[counteur_child_tableau_recap]
  parameter_final <- sub_list_dir_2[counteur_child_tableau_recap+1]
  parameter_short <- TRUE
  res <- knitr::knit_child("comp_sans_shiny_child.Rmd", envir = globalenv(), quiet = TRUE)
  cat(res, sep = "\n\n\\pagebreak\n")
  cat(paste0("## Step ", step, " from ", last_path(parameter_init), " to ", last_path(parameter_final)))
  step <- step+1
}


```
