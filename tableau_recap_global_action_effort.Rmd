---
title: "Summary of the treatment for a specific entity of the global tuna atlas"
eval.expr: TRUE
output:
  bookdown::pdf_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    always_allow_html: true
    extra_dependencies: "subfig"
    fig_caption: true
    tab_caption: true
    lof: true
    lot: true   
    alternative-title-page: front-and-back-matter/alt-title-page-example.tex
    header-includes:
    - \usepackage{booktabs}
    - \usepackage[T1]{fontenc}
  bookdown::html_document2:
    toc: true
    toc_depth: 3
    number_sections: true
    global_numbering: true
    toc_float: true
    toc_collapsed: true
    fig_caption: yes
    tab_caption: yes
date: "`r format(Sys.time(), '%d %B, %Y')`"
params:
  action: action
  entity: entity
  config: config
  filtering: !r list(unit = c("HOOKS", "DAYS"))
  fact: "effort"
---

 \clearpage


This document is aimed to recap the impact on the data of the different treatment of the Global Tuna Atlas. 

```{r include=FALSE}
knitr::opts_chunk$set(
	echo = FALSE,
	message = FALSE,
	warning = FALSE, fig.align = 'center'
)


```

```{r}

opts <- action
con <- config$software$output$dbi
parameter_fact = opts$fact
filter <- try(parameter_filtering = opts$filtering)
if("try-error" %in% class(filter)){parameter_filtering <- list(species = NULL)}
```

```{r}
knitr::knit_hooks$set(inline = function(x) {   if(!is.numeric(x)){     x   }else{    prettyNum(round(x,2), big.mark=",")    } })
if(!(require(base))){ 
  install.packages("base") 
  (require(base))} 
if(!(require(flextable))){ 
  install.packages("flextable") 
  (require(flextable))} 
if(!(require(remotes))){ 
  install.packages("remotes") 
  (require(remotes))} 
if(!(require(utils))){ 
  install.packages("utils") 
  (require(utils))} 
if(!(require(stringr))){ 
  install.packages("stringr") 
  (require(stringr))} 
if(!(require(knitr))){ 
  install.packages("knitr") 
  (require(knitr))} 
if(!(require(DBI))){ 
  install.packages("DBI") 
  (require(DBI))} 
if(!(require(odbc))){ 
  install.packages("odbc") 
  (require(odbc))} 
if(!(require(sf))){ 
  install.packages("sf") 
  (require(sf))} 
if(!(require(dplyr))){ 
  install.packages("dplyr") 
  (require(dplyr))} 
if(!(require(kableExtra))){ 
  install.packages("kableExtra") 
  (require(kableExtra))} 
if(!(require(readxl))){ 
  install.packages("readxl") 
  (require(readxl))} 
if(!(require(readr))){ 
  install.packages("readr") 
  (require(readr))} 
if(!(require(tidyr))){ 
  install.packages("tidyr") 
  (require(tidyr))} 
if(!(require(ggplot2))){ 
  install.packages("ggplot2") 
  (require(ggplot2))} 
if(!(require(stats))){ 
  install.packages("stats") 
  (require(stats))} 
if(!(require(RColorBrewer))){ 
  install.packages("RColorBrewer") 
  (require(RColorBrewer))} 
if(!(require(cowplot))){ 
  install.packages("cowplot") 
  (require(cowplot))} 
if(!require(sutdycatchesird)){
  if(!require(remotes)){
    install.packages("remotes")
  }
  require(remotes)
  install_github("BastienIRD/sutdycatchesird")
  require(sutdycatchesird)
}
if(!(require(tmap))){ 
  install.packages("tmap") 
  (require(tmap))} 
if(!(require(RPostgreSQL))){ 
  install.packages("RPostgreSQL") 
  (require(RPostgreSQL))} 
if(!(require(officer))){ 
  install.packages("officer") 
  (require(officer))} 
if(!(require(readtext))){ 
  install.packages("readtext") 
  (require(readtext))} 
```


```{r}
# knitr::opts_chunk$set(tab.cap.pre = "Table ", tab.cap.sep = ": ")

#set the table caption styling
# autonum <- officer::run_autonum(seq_id = "tab", bkm = "TC1", bkm_all = TRUE) # number the table, bkm (bookmark) is important as the cross-referencing is done using the bookmark
set_flextable_defaults(
  font.size = 10,
  font.color = "black",
  digits = 2,
  theme_fun = "theme_box"
)
qflextable2 =function(x, captionn = NULL, autonumm = autonum, pgwidth = 6, colour = FALSE){
  if("Captures table 1" %in% colnames(x)){
    y <-x %>% dplyr::mutate(`Captures table 1` = round(`Captures table 1`)) } 

  else {y <- x}
  y <- y %>% dplyr::mutate_if(is.factor, as.character) %>% dplyr::mutate_if(is.character, ~str_replace_all( ., ",", ", \n" )) %>% 
  dplyr::mutate_if(is.character,~str_replace_all( ., "_", "-" )) %>% dplyr::mutate_if(is.numeric, function(.){round(.,2)})
  flextable <- flextable(y)
  if(colour){
  flextable <- flextable %>% 
          color(~ `Difference (in % of tons)` < 0, color = "green",~ `Difference (in % of tons)`) %>% 
          color(~ `Difference (in % of tons)` >0, color = "red",~ `Difference (in % of tons)`)%>%   color(~ `Difference (in % of fish)` < 0, color = "green",~ `Difference (in % of fish)`) %>% 
          color(~ `Difference (in % of fish)` >0, color = "red",~ `Difference (in % of fish)`)%>%color(~ `Difference (in % of lines)` < 0, color = "green",~ `Difference (in % of lines)`) %>% 
          color(~ `Difference (in % of lines)` >0, color = "red",~ `Difference (in % of lines)`)
  } 
  if(!is.null(captionn)){flextable_captionned <- set_caption(flextable, caption = captionn,
  style = "Table Caption")} else {flextable_captionned <- flextable}
  ft_out <- flextable_captionned %>% autofit()
  ft_out <- width(ft_out, width = dim(ft_out)$widths*pgwidth /(flextable_dim(ft_out)$widths))

  return(ft_out)

}
base::options(knitr.duplicate.label = "allow")#for duplicate chunk names

```



```{r include=FALSE, results='asis'}

isNullList <- function(x) all(!lengths(x))
if (isNullList(parameter_filtering)){cat("There are no filter on this data")} else {
  
  cat (paste0("The filter used on this data are:  \n "))
  for (i in 1:length(parameter_filtering)){
    if (!is.null(parameter_filtering[[i]])){
      cat(paste0("***- On ", names((parameter_filtering)[i]), " : ", paste((parameter_filtering)[[i]], collapse = " ; "),"*** \n"))
    } else {""}
  }
}

```

```{r include=FALSE}
if(dir.exists("Markdown")){

  if(parameter_fact == "catch"){
    nominal_dataset <- readr::read_csv(paste0(getwd(),"/data/global_nominal_catch_firms_level0.csv"))}else if (parameter_fact == "effort"){
    nominal_dataset <- readr::read_csv(paste0(getwd(),"/data/global_nominal_catch_firms_level0.csv"))
  }


}

matchingList <- parameter_filtering %>% purrr::keep( ~ !is.null(.) )

filtering_function = function(dataframe_to_filter, filtering_params = matchingList){
  colnames_to_filter <- colnames(dataframe_to_filter %>% select(names(filtering_params)))
  names(filtering_params) <- colnames_to_filter

  filtering_params <- lapply(filtering_params, function(x){ #handling single filter
  if(length(x) == 1){
  x <- c(x, x) }else {
    x
  }
  }
    )
  
  if(length(matchingList)!= 0){  dataframe_to_filter <- dataframe_to_filter%>% filter(!! rlang::parse_expr(str_c(colnames_to_filter, matchingList, sep = '%in%', collapse="&")))} else{dataframe_to_filter}

}

nominal_dataset <- filtering_function(nominal_dataset)

  

```


First we present the data created by the GlobalTuna Atlas, as well as the comparison between this data and the rawdata provided by the RFMO's before the global Tuna Atlas treatment.

In a second time we will present the process of the GlobalTuna Atlas in order to reference exactly the choices made.

\clearpage

# Summary of the entity : `r entity$identifiers[["id"]]` 

```{r include=FALSE}
sub_list_dir_2 <- list.dirs(path =paste0(getwd(),"/Markdown"), full.names = TRUE, recursive = FALSE)
details = file.info(paste0(sub_list_dir_2,"/Markdown"))
details = file.info(sub_list_dir_2)
details = details[with(details, order(as.POSIXct(mtime))), ]
sub_list_dir_2 = rownames(details)
```


```{r echo=FALSE, results='asis'}
assign("titre_1", entity$identifiers[["id"]], envir = globalenv())

  assign("parameter_init", sub_list_dir_2[1], envir = globalenv())
  assign("child", TRUE, envir = globalenv())
  assign("parameter_con", con, envir = globalenv())
res2 <- knitr::knit_child("comp_sans_shiny_child_effort.Rmd", envir = environment(), options = list(params, parameter_init = parameter_init, child = TRUE, parameter_con = parameter_con,parameter_fact = parameter_fact ), quiet = TRUE)
```



```{r echo=FALSE, results='asis'}

cat(res2, sep =  "\\clearpage")


```

\clearpage


# Summary of the treatment done on the data (comparison between the first to the last)



```{r echo=FALSE, results='asis'}
assign("parameter_mapped", TRUE, envir = globalenv())

assign("child", TRUE, envir = globalenv())
  assign("parameter_init", sub_list_dir_2[1], envir = globalenv())
  assign("parameter_final", sub_list_dir_2[length(sub_list_dir_2)], envir = globalenv())
    assign("child_header", "#", envir= globalenv())
  

res <- knitr::knit_child("comp_sans_shiny_child_effort.Rmd", envir = globalenv(), options = list(params,parameter_fact = parameter_fact ), quiet = TRUE)

```




```{r echo=FALSE, results='asis'}



cat(res, sep =  "\\clearpage")

```





\clearpage

# Analyse of the processing of the data

```{r}
matchingList <- parameter_filtering %>% purrr::keep( ~ !is.null(.) )
matchingList <- lapply(matchingList, function(x){ #handling single filter
  if(length(x) == 1){
  x <- c(x, x) }else {
    x
  }

}
  )

filtering_function= function(dataframe_to_filter, matchingList){
  if(length(matchingList)!= 0){  
    colnames_to_filter <- colnames(dataframe_to_filter %>% select(names(matchingList)))
    names(matchingList) <- colnames_to_filter
    dataframe_to_filter <- dataframe_to_filter%>% filter(!! rlang::parse_expr(str_c(colnames_to_filter, matchingList, sep = '%in%', collapse="&")))}
return(dataframe_to_filter)
}
```



```{r include=FALSE, eval=(parameter_fact == "catch")}
if(!exists("nominal")){nominal <- 1}
df <- data.frame(matrix(ncol =12, nrow = 1))
      colnames(df) <- c(paste0(tail(str_split(paste0(sub_list_dir_2),"/")[[1]],n=1)),
                        "Explenation", "Fonctions", 
                        "Options", "Sum in tons", "Sum in number of fish", "Number of lines","Difference (in % of tons)","Difference in tons","Difference (in % of fish)", "Difference (in % of lines)", "Percentage of nominal"
      )
      # if((!is.null(opts))){ #have not change for species$filter
      #   tons_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[1])
      #   lines_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[3])
      #   nofish_init <- pull(read.csv(paste0(sub_list_dir_2[1],"/sums.csv"))[2])
      #   } else{
          main <- filtering_function(readRDS(paste0(sub_list_dir_2[1],"/rds.rds")), matchingList = matchingList)# %>% dplyr::filter(species%in%opts$species_filter)
          tons_init <- sum((main %>% dplyr::filter(unit%in%c("MTNO", "MT")))$value)
          nofish_init <- sum((main %>% dplyr::filter(unit%in%c("NOMT", "NO")))$value)
          lines_init <- nrow(main)
        # }
      for (i in sub_list_dir_2){
        # sums <- read.csv(paste0(i,"/sums.csv"))
        Explenation <- readtext(paste0(i,"/explication.txt"))[2]
        Fonctions <- pull(readtext(paste0(i,"/fonctions.txt"))[2])
        if (file.exists(paste0(i,"/options_written.txt"))){
          Options <- pull(readtext(paste0(i,"/options_written.txt"))[2])} else {Options <- "Aucune"}
        # if(!is.null(params$filter_species)){
          main <- filtering_function(readRDS(paste0(i,"/rds.rds")), matchingList = matchingList)# %>% dplyr::filter(species%in%params$filter_species)
          sum_t <- sum((main %>% dplyr::filter(unit%in%c("MTNO", "MT")))$value)
          sum_no <- sum((main %>% dplyr::filter(unit%in%c("NOMT", "NO")))$value)
          nrow <- nrow(main)
          
        # } else{sum_t <- pull(sums[1])
        # sum_no <-  pull(sums[2])
        # nrow <- pull(sums[3])}
        
        step <- tail(str_split(paste0(i),"/")[[1]],n=1)
        loss_percent <- 100*((tons_init - sum_t)/tons_init)
        loss_tons <- (tons_init - sum_t)
        loss_percent_lines <- 100*((lines_init - nrow)/lines_init)
        loss_percent_no <- 100*((nofish_init - sum_no)/nofish_init)
        percentage_of_nominal <- (sum_t*100)/nominal
        sums <- as.data.frame(data.frame(sum_t, sum_no, nrow))
        data_i <- cbind(step,
                        Explenation, Fonctions, 
                        Options,
                        sums, loss_percent,loss_tons,loss_percent_no, loss_percent_lines, percentage_of_nominal)
        names(data_i) <- colnames(df)
        df <- rbind(df, data_i)
        tons_init <- sum_t
        nofish_init <- sum_no
        lines_init <- nrow
        
      }
      df2 = df[-1,]
      df2[df2 == -Inf] <- 0
      colnames(df2)[1] <- "Step"
      # df <- df %>%  rename(Step = rawdata)



     

      reduced <- df2 %>% mutate(`Sum in millions of tons` = `Sum in tons` / 1000000, `Sum in millions of fish` = `Sum in number of fish` / 1000000)%>% select(Step, `Sum in millions of tons`, `Sum in millions of fish`, `Number of lines`)%>% dplyr::mutate(Step_number = as.numeric(row_number()))
      reduced$Step <- factor(reduced$Step, levels = (reduced %>% arrange(Step_number))$Step)
      

coeff <- 3
temperatureColor <- "#69b3a2"
      
priceColor <- rgb(0.2, 0.6, 0.9, 1)

second_graf <- ggplot(reduced,aes(x = Step,group = 1))+ 
        geom_line( aes(y=`Sum in millions of tons` ,group = 1), size=0.5, color=priceColor)+geom_point( aes(y=`Sum in millions of tons` ,group = 1)) +
        geom_line( aes(y=`Sum in millions of fish`/ coeff,group = 1), size=0.5, color=temperatureColor)+geom_point( aes(y=`Sum in millions of fish`/ coeff))  +
        scale_y_continuous(
          
          # Features of the first axis
          name = "Tons",
          
          # Add a second axis and specify its features
          sec.axis = sec_axis(~.*coeff, name="Number of fish")
        ) + 
        
        
        
        theme(
          axis.title.y = element_text(color = priceColor, size=8),
          axis.title.y.right = element_text(color = temperatureColor, size=8)
        ) +
        
        ggtitle("Evolution of the repartition of captures depending on units and Steps")+
        theme(axis.text.x = element_text(angle = 90))

no_fish_plot <- ggplot(reduced,aes(x = Step,group = 1)) +geom_line( aes(y=`Sum in millions of fish`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
      
tons_plot <- ggplot(reduced,aes(x = Step,group = 1)) +
geom_line( aes(y=`Sum in millions of tons`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
```

```{r include=FALSE , eval=(parameter_fact == "effort")}
if(!exists("nominal")){nominal <- 1}
df <- data.frame(matrix(ncol =12, nrow = 1))
      colnames(df) <- c(paste0(tail(str_split(paste0(sub_list_dir_2),"/")[[1]],n=1)),
                        "Explenation", "Fonctions", 
                        "Options", "Sum in hooks", "Sum in fishing days", "Number of lines","Difference (in % of hooks)","Difference in hooks","Difference (in % of fish)", "Difference (in % of lines)", "Percentage of nominal"
      )

          main <- filtering_function(readRDS(paste0(sub_list_dir_2[1],"/rds.rds")), matchingList = matchingList)# %>% dplyr::filter(species%in%opts$species_filter)
          hooks_init <- sum((main %>% dplyr::filter(unit%in%c("HOOKS", "HOOKS")))$value)
          fishing_days_init <- sum((main %>% dplyr::filter(unit%in%c("FDAYS", "FDAYS")))$value)
          lines_init <- nrow(main)
        
      for (i in sub_list_dir_2){
        sums <- read.csv(paste0(i,"/sums.csv"))
        Explenation <- readtext(paste0(i,"/explication.txt"))[2]
        Fonctions <- pull(readtext(paste0(i,"/fonctions.txt"))[2])
        if (file.exists(paste0(i,"/options_written.txt"))){
          Options <- pull(readtext(paste0(i,"/options_written.txt"))[2])} else {Options <- "Aucune"}
          main <- filtering_function(readRDS(paste0(i,"/rds.rds")), matchingList = matchingList)# %>% dplyr::filter(species%in%params$filter_species)
          sum_hooks <- sum((main %>% dplyr::filter(unit%in%c("HOOKS", "HOOKS")))$value)
          sum_fdays <- sum((main %>% dplyr::filter(unit%in%c("FDAYS", "FDAYS")))$value)
          nrow <- nrow(main)
          

        step <- tail(str_split(paste0(i),"/")[[1]],n=1)
        loss_percent <- 100*((hooks_init - sum_hooks)/hooks_init)
        loss_hooks <- (hooks_init - sum_hooks)
        loss_percent_lines <- 100*((lines_init - nrow)/lines_init)
        loss_percent_fdays <- 100*((fishing_days_init - sum_fdays)/fishing_days_init)
        percentage_of_nominal <- (sum_hooks*100)/nominal
        sums <- as.data.frame(data.frame(sum_hooks, sum_fdays, nrow))
        data_i <- cbind(step,
                        Explenation, Fonctions, 
                        Options,
                        sums, loss_percent,loss_hooks,loss_percent_fdays, loss_percent_lines, percentage_of_nominal)
        names(data_i) <- colnames(df)
        df <- rbind(df, data_i)
        hooks_init <- sum_hooks
        fishing_days_init <- sum_fdays
        lines_init <- nrow
        
      }
      df2 = df[-1,]
      df2[df2 == -Inf] <- 0
      colnames(df2)[1] <- "Step"
      # df <- df %>%  rename(Step = rawdata)



     

      reduced <- df2 %>% mutate(`Sum in millions of hooks` = `Sum in hooks` / 1000000, `Sum in millions of days` = `Sum in fishing days` / 1000000)%>% select(Step, `Sum in millions of hooks`, `Sum in millions of days`, `Number of lines`)%>% dplyr::mutate(Step_number = as.numeric(row_number()))
      reduced$Step <- factor(reduced$Step, levels = (reduced %>% arrange(Step_number))$Step)
      

coeff <- 3
temperatureColor <- "#69b3a2"
      
priceColor <- rgb(0.2, 0.6, 0.9, 1)

second_graf <- ggplot(reduced,aes(x = Step,group = 1))+ 
        geom_line( aes(y=`Sum in millions of hooks` ,group = 1), size=0.5, color=priceColor)+geom_point( aes(y=`Sum in millions of hooks` ,group = 1)) +
        geom_line( aes(y=`Sum in millions of days`/ coeff,group = 1), size=0.5, color=temperatureColor)+geom_point( aes(y=`Sum in millions of days`/ coeff))  +
        scale_y_continuous(
          
          # Features of the first axis
          name = "hooks",
          
          # Add a second axis and specify its features
          sec.axis = sec_axis(~.*coeff, name="fishing days")
        ) + 
        
        
        
        theme(
          axis.title.y = element_text(color = priceColor, size=8),
          axis.title.y.right = element_text(color = temperatureColor, size=8)
        ) +
        
        ggtitle("Evolution of the repartition of captures depending on units and Steps")+
        theme(axis.text.x = element_text(angle = 90))

fishing_days_plot <- ggplot(reduced,aes(x = Step,group = 1)) +geom_line( aes(y=`Sum in millions of days`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
      
hooks_plot <- ggplot(reduced,aes(x = Step,group = 1)) +
geom_line( aes(y=`Sum in millions of hooks`,group = 1), size=0.5)+theme(axis.text.x = element_text(angle = 90))
```


```{r echo=FALSE, results='asis', eval=(parameter_fact == "catch")}
qflextable2(reduced, colour = FALSE, captionn ="Evolution of Sum in tons and Sum in number of fish and lines along the steps")
```

```{r echo=FALSE, results='asis', eval=(parameter_fact == "effort")}
qflextable2(reduced, colour = FALSE, captionn ="Evolution of Sum in hooks and Sum in fishing days and lines along the steps")
```


```{r echo=FALSE, fig.cap='Evolution of captures in tons and number of fish during the process',results='asis', eval=(parameter_fact == "catch")}



cowplot::plot_grid(tons_plot, no_fish_plot)



```

```{r echo=FALSE, fig.cap='Evolution of captures in fishing days and hooks during the process',results='asis', eval=(parameter_fact == "effort")}

cowplot::plot_grid(fishing_days_plot, hooks_plot)

```

```{r eval=FALSE, include=FALSE, results='asis'}
try(res3 <- knitr::knit_child("tableau_recap_entity_child.Rmd", envir = globalenv(), quiet = TRUE))
try(cat(res3, sep =  "\\clearpage"))

```



```{r}


last_path = function(x){tail(stringr::str_split(x,"/")[[1]],n=1)}

```


# Detail of all the steps of treatment of the data

For each treatment on the data, we provide a report on what exactly has been created, disappeared or has been transformed.

```{r eval  =FALSE}
for (counteur_child_tableau_recap in (1:(length(sub_list_dir_2)-1)))  {  
  print(paste0("compteur = ",counteur_child_tableau_recap))
  parameter_init <- sub_list_dir_2[counteur_child_tableau_recap]
  print(paste0("param init = ",parameter_init))
  parameter_final <- sub_list_dir_2[counteur_child_tableau_recap+1]
  print(parameter_final)
  print("new")


  }
```

```{r}
function_all_comp <- function(counting){
  assign("parameter_init", sub_list_dir_2[counting], envir = globalenv())
  assign("parameter_final", sub_list_dir_2[counting+1], envir = globalenv())
  assign("parameter_short", TRUE, envir = globalenv())
  assign("child", TRUE, envir = globalenv())
  assign("step", counting, envir = globalenv())
  assign("child_header", "# ", envir= globalenv())
  assign("step_title", paste0("Treatment : " ,last_path(parameter_final)), envir= globalenv())

  res <- knitr::knit_child("comp_sans_shiny_child_effort.Rmd", envir = globalenv(), options = list(params, parameter_init = sub_list_dir_2[counting], parameter_final = sub_list_dir_2[counting+1],  step_title = paste0(" Treatment : " ,last_path(parameter_final)), parameter_con=parameter_con,parameter_fact = parameter_fact ), quiet = TRUE)
}

all <- lapply(1:(length(sub_list_dir_2)-1), function_all_comp)

```

```{r echo=FALSE, results='asis'}


cat(unlist(all), sep = paste0( "\\clearpage"))

```


```{r echo = FALSE, results='asis', eval=FALSE}
step <- 1
assign("parameter_mapped", FALSE, envir = globalenv())
for (counteur_child_tableau_recap in (1:(length(sub_list_dir_2)-1)))  {  
  parameter_init <- sub_list_dir_2[counteur_child_tableau_recap]
  parameter_final <- sub_list_dir_2[counteur_child_tableau_recap+1]
  parameter_short <- TRUE
  res <- knitr::knit_child("comp_sans_shiny_child.Rmd", envir = globalenv(), quiet = TRUE)
  cat(res, sep = "\n\n\\pagebreak\n")
  cat(paste0("## Step ", step, " from ", last_path(parameter_init), " to ", last_path(parameter_final)))
  step <- step+1
}


```

\clearpage

# Annexe

```{r echo=FALSE, results='asis'}
colnames(df2)[1] <-  "Treatment"
qflextable2(df2 %>% select(c("Treatment", "Explenation", "Function"= "Fonctions")), colour = FALSE, captionn ="Review of all the impact and purpose of every the treatment done")

```


```{r}
errormapping <- try(df_mapping_final_this_dimension <- read_csv("data/mapping_codelist_summary.csv"))
if("try-error" %in% class(errormapping)){knitr::knit_exit(fully = FALSE)}
```


```{r}
t <- df_mapping_final_this_dimension %>% select(-trg_codingsystem)%>%group_by(across(everything())) %>%  mutate(src_codingsystem = unlist(str_split(src_codingsystem, "_"))[1]) %>% ungroup() %>% mutate(src_code = as.character(src_code)) %>% ungroup() %>%  group_by(source_authority) %>%  mutate(row = row_number()) %>% filter(src_code != trg_code)

i <-pivot_wider(t %>% group_by(source_authority) , names_from = source_authority, names_prefix = "Ancient name for ", values_from = "src_code")  %>% rename("New code" = trg_code) %>% rename(Dimension = src_codingsystem)%>%
    relocate(Dimension) %>% select(-row)
ster <- i %>% group_by(Dimension, `New code`) %>% summarise_at(vars(-group_cols()),funs(toString)) %>% mutate_all(.funs = function(x){gsub(",$", "",gsub(c("NA", ",NA", " NA"), "", gsub("  ","",gsub("NA,", "", x))))})


t <- flextable::as_grouped_data(ster, groups = c("Dimension"))
```

```{r}
qflextable2(t, caption = "Replacement code during the mapping codelist treatment")
```

